# Perses Helm Chart Values
# Reference: https://github.com/perses/helm-charts

replicaCount: 1

image:
  registry: docker.io
  repository: persesdev/perses
  tag: v0.50.0-distroless
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 8080

resources:
  requests:
    cpu: 50m
    memory: 64Mi
  limits:
    cpu: 200m
    memory: 128Mi

# Persistence configuration
persistence:
  enabled: true
  storageClassName: longhorn
  size: 5Gi

# Pod security context
securityContext:
  fsGroup: 65534
  runAsUser: 65534
  runAsGroup: 65534
  runAsNonRoot: true

# Container security context
containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# Perses configuration
config:
  # Schemas configuration for distroless image
  schemas:
    panels_path: "/etc/perses/cue/schemas/panels"
    queries_path: "/etc/perses/cue/schemas/queries"
    datasources_path: "/etc/perses/cue/schemas/datasources"
    variables_path: "/etc/perses/cue/schemas/variables"

  # Security configuration
  security:
    readonly: false
    enable_auth: false
    authorization:
      guest_permissions:
        - actions: ["read"]
          scopes: ["*"]

  # Database configuration
  database:
    file:
      folder: "/perses/data"
      extension: "json"

  # Frontend configuration
  frontend:
    explorer:
      enable: true
    information: |
      ## Welcome to Perses

      Perses is a CNCF sandbox project for observability visualization.

      **Configured Datasources:**
      - VictoriaMetrics (Prometheus-compatible)

      **Documentation:** [perses.dev](https://perses.dev)

# Provisioning configuration
provisioning:
  enabled: true
  datasources:
    - name: victoriametrics
      project: default
      default: true
      display:
        name: VictoriaMetrics
      plugin:
        kind: PrometheusDatasource
        spec:
          proxy:
            kind: HTTPProxy
            spec:
              url: http://victoria-metrics.monitoring.svc.cluster.local:8428
              allowedEndpoints:
                - endpointPattern: "/api/v1/labels"
                  method: "POST"
                - endpointPattern: "/api/v1/labels"
                  method: "GET"
                - endpointPattern: "/api/v1/series"
                  method: "POST"
                - endpointPattern: "/api/v1/series"
                  method: "GET"
                - endpointPattern: "/api/v1/metadata"
                  method: "GET"
                - endpointPattern: "/api/v1/query"
                  method: "POST"
                - endpointPattern: "/api/v1/query"
                  method: "GET"
                - endpointPattern: "/api/v1/query_range"
                  method: "POST"
                - endpointPattern: "/api/v1/query_range"
                  method: "GET"
                - endpointPattern: "/api/v1/label/([a-zA-Z0-9_-]+)/values"
                  method: "GET"

  projects:
    - name: default
      display:
        name: Default Project

# Node affinity - prefer non-control-plane nodes
affinity:
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
            - key: node-role.kubernetes.io/control-plane
              operator: DoesNotExist

# Probes configuration
livenessProbe:
  httpGet:
    path: /api/v1/health
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5

readinessProbe:
  httpGet:
    path: /api/v1/health
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
