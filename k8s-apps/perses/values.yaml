# Perses Helm Chart Values
# Reference: https://github.com/perses/helm-charts

replicas: 1

image:
  name: docker.io/persesdev/perses
  version: v0.50.0-distroless
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 8080

resources:
  requests:
    cpu: 50m
    memory: 64Mi
  limits:
    cpu: 200m
    memory: 128Mi

# Persistence configuration
persistence:
  enabled: true
  storageClass: longhorn
  size: 5Gi
  accessModes:
    - ReadWriteOnce
  # Security context for persistent volume (only fsGroup is supported)
  securityContext:
    fsGroup: 65534

# Perses configuration
config:
  # Schemas configuration for distroless image
  schemas:
    panels_path: "/etc/perses/cue/schemas/panels"
    queries_path: "/etc/perses/cue/schemas/queries"
    datasources_path: "/etc/perses/cue/schemas/datasources"
    variables_path: "/etc/perses/cue/schemas/variables"

  # Security configuration (use camelCase property names)
  security:
    readOnly: false
    enableAuth: false
    authorization:
      guest_permissions:
        - actions: ["read"]
          scopes: ["*"]

  # Database configuration
  database:
    file:
      folder: "/perses/data"
      extension: "json"

  # Important dashboards (frontend configuration moved here)
  important_dashboards: []

# Datasources configuration
datasources:
  - name: victoriametrics
    project: default
    default: true
    display:
      name: VictoriaMetrics
    plugin:
      kind: PrometheusDatasource
      spec:
        proxy:
          kind: HTTPProxy
          spec:
            url: http://victoria-metrics.monitoring.svc.cluster.local:8428
            allowedEndpoints:
              - endpointPattern: "/api/v1/labels"
                method: "POST"
              - endpointPattern: "/api/v1/labels"
                method: "GET"
              - endpointPattern: "/api/v1/series"
                method: "POST"
              - endpointPattern: "/api/v1/series"
                method: "GET"
              - endpointPattern: "/api/v1/metadata"
                method: "GET"
              - endpointPattern: "/api/v1/query"
                method: "POST"
              - endpointPattern: "/api/v1/query"
                method: "GET"
              - endpointPattern: "/api/v1/query_range"
                method: "POST"
              - endpointPattern: "/api/v1/query_range"
                method: "GET"
              - endpointPattern: "/api/v1/label/([a-zA-Z0-9_-]+)/values"
                method: "GET"

# Probes configuration
livenessProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 5

readinessProbe:
  enabled: true
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  successThreshold: 1
  failureThreshold: 5
