apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  # ntfy webhook service - uses secret for auth token
  service.webhook.ntfy: |
    url: https://ntfy.sh/ee4ccfad-efdb-4862-8f38-d7455bcbd198
    headers:
      - name: Authorization
        value: Bearer $ntfy-token
      - name: X-Priority
        value: "{{if eq .app.status.operationState.phase \"Failed\"}}urgent{{else if eq .app.status.operationState.phase \"Error\"}}high{{else}}default{{end}}"
      - name: X-Tags
        value: "{{if eq .app.status.operationState.phase \"Succeeded\"}}white_check_mark{{else if eq .app.status.operationState.phase \"Failed\"}}x{{else}}warning{{end}}"
      - name: X-Title
        value: "ArgoCD: {{.app.metadata.name}}"

  # Triggers - when to send notifications
  trigger.on-sync-succeeded: |
    - when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'
      send: [app-sync-succeeded]

  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error', 'Failed']
      send: [app-sync-failed]

  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [app-health-degraded]

  # Templates - notification content
  template.app-sync-succeeded: |
    webhook:
      ntfy:
        method: POST
        body: |
          Application {{.app.metadata.name}} synced successfully.
          Revision: {{.app.status.sync.revision | trunc 7}}
          Project: {{.app.spec.project}}

  template.app-sync-failed: |
    webhook:
      ntfy:
        method: POST
        body: |
          Application {{.app.metadata.name}} sync FAILED!
          Project: {{.app.spec.project}}
          Error: {{.app.status.operationState.message}}

  template.app-health-degraded: |
    webhook:
      ntfy:
        method: POST
        body: |
          Application {{.app.metadata.name}} health is degraded.
          Project: {{.app.spec.project}}
          Status: {{.app.status.health.status}}

  # Default triggers (applied to all apps unless overridden)
  defaultTriggers: |
    - on-sync-failed
    - on-health-degraded
