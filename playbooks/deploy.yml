---
# =============================================================================
# Complete Infrastructure Deployment Playbook
# =============================================================================
# This playbook orchestrates the deployment of infrastructure components
# managed by Ansible. Applications are managed by ArgoCD via k8s-apps/.
#
# Components (Ansible-managed):
#   - Infrastructure: Raspberry Pi configuration, NFS support
#   - K3s: K3s cluster agent configuration
#   - Core: Storage (Longhorn), Security (cert-manager), Networking (Traefik), GitOps (ArgoCD)
#
# Components (ArgoCD-managed via k8s-apps/):
#   - Applications: Jellyfin, Media stack, Paperless, Immich, Personal Site, Agate
#   - Dashboards: Kubernetes Dashboard, Headlamp, Homepage
#   - Monitoring: Victoria Metrics, Node Exporter
#
# Usage:
#   # Deploy everything
#   ansible-playbook -i inventory/hosts.yml playbooks/deploy.yml
#
#   # Deploy only specific components
#   ansible-playbook -i inventory/hosts.yml playbooks/deploy.yml --tags infrastructure
#   ansible-playbook -i inventory/hosts.yml playbooks/deploy.yml --tags core
#
#   # Skip certain components
#   ansible-playbook -i inventory/hosts.yml playbooks/deploy.yml --skip-tags ipv6
#
# Available tags:
#   - infrastructure: Base infrastructure setup (Pi config, NFS, IPv6)
#   - k3s: K3s cluster configuration
#   - core: Core Kubernetes components (Longhorn, cert-manager, Traefik, ArgoCD)
#   - storage: Storage solutions (Longhorn)
#   - security: Security components (cert-manager)
#   - networking: Networking components (Traefik)
#   - gitops: GitOps components (ArgoCD)
#
# For more details on each component, see the individual playbook files:
#   - playbooks/infrastructure.yml
#   - playbooks/k3s.yml
#   - playbooks/core.yml
# =============================================================================

# Import modular playbooks
- name: Deploy infrastructure
  ansible.builtin.import_playbook: infrastructure.yml
  tags: [infrastructure]

- name: Deploy K3s cluster configuration
  ansible.builtin.import_playbook: k3s.yml
  tags: [k3s]

- name: Deploy Kubernetes core components
  ansible.builtin.import_playbook: core.yml
  tags: [core]

# =============================================================================
# Deployment Summary
# =============================================================================

- name: Display deployment summary
  hosts: localhost
  connection: local
  gather_facts: true
  tags: [always]
  tasks:
    - name: Show deployment completion message
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════╗
          ║             Deployment Complete!                             ║
          ╚══════════════════════════════════════════════════════════════╝

          Deployment finished at: {{ ansible_facts['date_time']['iso8601'] }}

          Ansible manages:
          - Infrastructure (Pi setup, NFS, static IPs)
          - K3s cluster configuration
          - Core components (Longhorn, cert-manager, Traefik, ArgoCD)

          ArgoCD manages (via k8s-apps/):
          - Applications (Jellyfin, Sonarr, Radarr, Paperless, Immich, etc.)
          - Dashboards (Kubernetes Dashboard, Headlamp, Homepage)
          - Monitoring (Victoria Metrics, Node Exporter, Grafana)

          Next steps:
          - Verify deployments: kubectl get pods --all-namespaces
          - Check ArgoCD sync status: argocd app list

          For troubleshooting, see: CLAUDE.md
