---
- name: Update all packages on all systems
  hosts: all
  become: yes
  gather_facts: yes
  serial: "{{ update_serial | default('100%') }}"
  
  vars:
    # Update configuration
    auto_reboot: false
    reboot_delay: 30
    # Notification configuration
    ntfy_topic: "{{ ntfy_update_topic | default('ee4ccfad-efdb-4862-8f38-d7455bcbd198') }}"
    ntfy_auth: "{{ ntfy_update_auth | default(omit) }}"
    
  pre_tasks:
    - name: Display system information
      debug:
        msg: |
          Updating packages on {{ inventory_hostname }}
          OS: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}
          Architecture: {{ ansible_facts['architecture'] }}
          Package Manager: {{ ansible_facts['pkg_mgr'] }}

  tasks:
    - block:
        - name: Run system update
          include_role:
            name: infra_system_update

        - name: Display completion message
          debug:
            msg: "Package update completed on {{ inventory_hostname }}"
            
        - name: Reboot notification (manual reboot needed)
          debug:
            msg: |
              ‚ö†Ô∏è  ATTENTION: {{ inventory_hostname }} requires a reboot to complete the update.
              You can reboot manually or run with -e auto_reboot=true to reboot automatically.
          when:
            - reboot_required is defined and reboot_required|bool
            - not auto_reboot|bool

        - name: Reboot system
          reboot:
            reboot_timeout: 600
            connect_timeout: 20
            pre_reboot_delay: "{{ reboot_delay }}"
          when:
            - auto_reboot|bool
            - reboot_required is defined and reboot_required|bool
          register: reboot_result

        - name: Set rebooted fact
          set_fact:
            was_rebooted: true
          when: reboot_result is changed

      rescue:
        - name: Display update failure
          debug:
            msg: "‚ùå Package update failed on {{ inventory_hostname }}"

        - name: Re-raise the failure
          fail:
            msg: "Update failed on {{ inventory_hostname }}"

# Summary play (runs after all hosts are processed)
- name: Display update summary
  hosts: localhost
  connection: local
  gather_facts: true

  tasks:
    - name: Display update summary
      debug:
        msg: |
          üìä Update Summary Report

          Total servers: {{ groups['all'] | length }}
          Completed: {{ ansible_play_hosts_all | default([]) | length }}
          Time: {{ ansible_facts['date_time']['iso8601'] }}

          {% set rebooted = [] %}
          {% set needs_reboot = [] %}
          {% for host in groups['all'] %}
          {% if hostvars[host].was_rebooted is defined and hostvars[host].was_rebooted %}
          {% set _ = rebooted.append(host) %}
          {% elif hostvars[host].reboot_required is defined and hostvars[host].reboot_required %}
          {% set _ = needs_reboot.append(host) %}
          {% endif %}
          {% endfor %}
          {% if rebooted %}
          Servers rebooted:
          {% for host in rebooted %}
          - {{ host }}
          {% endfor %}
          {% endif %}
          {% if needs_reboot %}
          Servers requiring reboot:
          {% for host in needs_reboot %}
          - {{ host }}
          {% endfor %}
          {% endif %} 