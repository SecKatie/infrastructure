---
# =============================================================================
# Infrastructure Configuration Playbook
# =============================================================================
# This playbook configures the base infrastructure including:
#   - Raspberry Pi node configuration (iSCSI, cgroups)
#   - NFS support on all nodes
#   - Optional IPv6 disabling
#   - Squid proxy with Cloudflare tunnel (super6c_node_4)
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/infrastructure.yml
#
#   # Deploy only Squid proxy
#   ansible-playbook -i inventory/hosts.yml playbooks/infrastructure.yml --tags squid
#
#   # Skip IPv6 configuration (it's tagged 'never' by default)
#   ansible-playbook -i inventory/hosts.yml playbooks/infrastructure.yml --tags ipv6
#
# Tags:
#   - infrastructure: All infrastructure tasks
#   - rpi: Raspberry Pi specific configuration
#   - nfs: NFS client installation
#   - ipv6: IPv6 disabling (tagged 'never' by default)
#   - squid: Squid proxy with Cloudflare tunnel
# =============================================================================

- name: Configure Raspberry Pi nodes
  hosts: all_raspberry_pi
  become: true
  tags: [infrastructure, rpi]
  roles:
    - role: infra_rpi_setup
      tags: [rpi_setup]

- name: Install NFS support on Raspberry Pi nodes
  hosts: all_raspberry_pi
  become: true
  tags: [infrastructure, nfs]
  tasks:
    - name: Install nfs-common package
      ansible.builtin.apt:
        name: nfs-common
        state: present
        update_cache: true

- name: Install NFS support on RHEL nodes
  hosts: rhel_k3s_agents
  become: true
  tags: [infrastructure, nfs]
  tasks:
    - name: Install nfs-utils package
      ansible.builtin.dnf:
        name: nfs-utils
        state: present

- name: Disable IPv6 on Raspberry Pi nodes (optional)
  hosts: all_raspberry_pi
  become: true
  gather_facts: true
  tags: [infrastructure, ipv6, never]
  tasks:
    - name: Disable IPv6 via sysctl
      ansible.posix.sysctl:
        name: "{{ item }}"
        value: "1"
        state: present
        reload: true
        sysctl_file: /etc/sysctl.d/99-disable-ipv6.conf
      loop:
        - net.ipv6.conf.all.disable_ipv6
        - net.ipv6.conf.default.disable_ipv6
        - net.ipv6.conf.lo.disable_ipv6

    - name: Verify IPv6 is disabled
      ansible.builtin.shell: cat /proc/sys/net/ipv6/conf/all/disable_ipv6
      register: ipv6_status
      changed_when: false

    - name: Display IPv6 status
      ansible.builtin.debug:
        msg: "IPv6 disabled: {{ ipv6_status.stdout == '1' }}"

    - name: Check if k3s server service exists
      ansible.builtin.systemd:
        name: k3s
      register: k3s_server_status
      ignore_errors: true

    - name: Restart k3s server to apply changes
      ansible.builtin.systemd:
        name: k3s
        state: restarted
      when:
        - ipv6_status.stdout == '1'
        - k3s_server_status.status.LoadState is defined
        - k3s_server_status.status.LoadState == 'loaded'

    - name: Restart k3s agent to apply changes
      ansible.builtin.systemd:
        name: k3s-agent
        state: restarted
      when:
        - ipv6_status.stdout == '1'
        - k3s_server_status.failed | default(false)

    - name: Wait for k3s to be ready
      ansible.builtin.wait_for:
        port: 6443
        delay: 10
        timeout: 60
      when:
        - ipv6_status.stdout == '1'
        - k3s_server_status.status.LoadState is defined
        - k3s_server_status.status.LoadState == 'loaded'

# =============================================================================
# Squid Proxy with Cloudflare Tunnel (super6c_node_4)
# =============================================================================
# Deploys Squid proxy accessible via Cloudflare tunnel at proxy.mulliken.net
# Used by Uptime Kuma on VPS to monitor internal services
# =============================================================================

- name: Deploy Squid Proxy on super6c_node_4
  hosts: super6c_node_4
  become: true
  gather_facts: true
  tags: [infrastructure, squid]
  vars_files:
    - vars/squid_secrets.yml
  roles:
    - role: infra_squid
      tags: [squid]

- name: Deploy Cloudflare DDNS for Squid Proxy
  hosts: super6c_node_4
  become: true
  gather_facts: true
  tags: [infrastructure, squid, ddns]
  vars_files:
    - vars/squid_secrets.yml
  vars:
    cloudflare_ddns_hostname: "proxy.mulliken.net"
  roles:
    - role: infra_cloudflare_ddns
      tags: [ddns]
