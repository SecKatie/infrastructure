---
- name: Deploy tunnel credentials
  ansible.builtin.copy:
    content: "{{ cf_tunnel_credentials.content | b64decode }}"
    dest: "{{ cloudflared_config_dir }}/{{ cloudflared_tunnel_id }}.json"
    owner: "{{ cloudflared_user }}"
    group: "{{ cloudflared_group }}"
    mode: "0600"
  become: true
  notify: Restart cloudflared

- name: Deploy cloudflared configuration
  ansible.builtin.template:
    src: config.yml.j2
    dest: "{{ cloudflared_config_dir }}/config.yml"
    owner: "{{ cloudflared_user }}"
    group: "{{ cloudflared_group }}"
    mode: "0640"
  become: true
  notify: Restart cloudflared

- name: Deploy cloudflared systemd service
  ansible.builtin.template:
    src: cloudflared.service.j2
    dest: /etc/systemd/system/cloudflared.service
    owner: root
    group: root
    mode: "0644"
  become: true
  notify:
    - Reload systemd
    - Restart cloudflared

- name: Enable and start cloudflared service
  ansible.builtin.systemd:
    name: cloudflared
    state: started
    enabled: true
    daemon_reload: true
  become: true

- name: Display cloudflared status
  ansible.builtin.debug:
    msg: |
      Cloudflared tunnel deployed successfully!
      Tunnel: {{ cloudflared_tunnel_name }}
      ID: {{ cloudflared_tunnel_id }}
      Hostname: {{ cloudflared_hostname }} -> {{ cloudflared_service_url }}
