---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - squid_auth_username is defined
      - squid_auth_username | length > 0
      - squid_auth_password is defined
      - squid_auth_password | length > 0
    fail_msg: "squid_auth_username and squid_auth_password must be defined (from vault)"

- name: Install Squid and apache2-utils (for htpasswd)
  ansible.builtin.apt:
    name:
      - squid
      - apache2-utils
    state: present
    update_cache: true
  become: true

- name: Create Squid cache directory
  ansible.builtin.file:
    path: /var/spool/squid
    state: directory
    owner: proxy
    group: proxy
    mode: "0755"
  become: true

- name: Create htpasswd file for Squid authentication
  ansible.builtin.shell: |
    htpasswd -cb /etc/squid/passwd "{{ squid_auth_username }}" "{{ squid_auth_password }}"
  args:
    creates: /etc/squid/passwd
  become: true
  no_log: true
  notify: Restart squid

- name: Ensure htpasswd file has correct permissions
  ansible.builtin.file:
    path: /etc/squid/passwd
    owner: root
    group: proxy
    mode: "0640"
  become: true

- name: Update htpasswd if credentials changed
  ansible.builtin.shell: |
    htpasswd -cb /etc/squid/passwd "{{ squid_auth_username }}" "{{ squid_auth_password }}"
  become: true
  no_log: true
  changed_when: true
  notify: Restart squid
  tags: [update_credentials]

- name: Import TLS tasks
  ansible.builtin.import_tasks: tls.yml
  when: squid_tls_enabled | default(false)

- name: Deploy Squid configuration
  ansible.builtin.template:
    src: squid.conf.j2
    dest: /etc/squid/squid.conf
    owner: root
    group: root
    mode: "0644"
    backup: true
    validate: "squid -k parse -f %s"
  become: true
  notify: Restart squid

- name: Initialize Squid cache directories
  ansible.builtin.command:
    cmd: squid -z
  become: true
  register: squid_cache_init
  changed_when: false
  failed_when: false

- name: Enable and start Squid service
  ansible.builtin.systemd:
    name: squid
    state: started
    enabled: true
  become: true

- name: Display Squid status
  ansible.builtin.debug:
    msg: |
      Squid proxy deployed successfully!
      HTTP:  {{ squid_bind_address }}:{{ squid_port }}
      {% if squid_tls_enabled | default(false) %}
      HTTPS: {{ squid_bind_address }}:{{ squid_tls_port }}
      {% endif %}
      Authentication: Basic auth enabled
