---
apiVersion: v1
kind: ConfigMap
metadata:
  name: perses-config
  namespace: {{ perses_namespace }}
  labels:
    app.kubernetes.io/name: perses
    app.kubernetes.io/instance: perses
    app.kubernetes.io/part-of: observability
    app.kubernetes.io/component: configuration
    app.kubernetes.io/managed-by: ansible
data:
  config.yaml: |
    # Perses Server Configuration
    # https://perses.dev

    # Security configuration
    security:
      readonly: false
      enable_auth: false
{% if perses_anonymous_access | default(true) %}
      authorization:
        guest_permissions:
          - actions: ["read"]
            scopes: ["*"]
{% endif %}

    # Database configuration - file-based storage
    database:
      file:
        folder: "/perses/data"
        extension: "json"

    # Provisioning - load datasources and dashboards from files
    provisioning:
      folders:
        - "/perses/provisioning"

    # Frontend configuration
    frontend:
      explorer:
        enable: true
      information: |
        ## Welcome to Perses

        Perses is a CNCF sandbox project for observability visualization.

        **Configured Datasources:**
        - {{ perses_prometheus_name }} (Prometheus-compatible)

        **Documentation:** [perses.dev](https://perses.dev)
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: perses-provisioning
  namespace: {{ perses_namespace }}
  labels:
    app.kubernetes.io/name: perses
    app.kubernetes.io/instance: perses
    app.kubernetes.io/part-of: observability
    app.kubernetes.io/component: provisioning
    app.kubernetes.io/managed-by: ansible
data:
  # Default project
  project.json: |
    {
      "kind": "Project",
      "metadata": {
        "name": "default"
      },
      "spec": {
        "display": {
          "name": "Default Project"
        }
      }
    }
  # Victoria Metrics datasource
  datasource.json: |
    {
      "kind": "Datasource",
      "metadata": {
        "name": "{{ perses_prometheus_name | lower | replace(' ', '-') }}",
        "project": "default"
      },
      "spec": {
        "default": true,
        "display": {
          "name": "{{ perses_prometheus_name }}"
        },
        "plugin": {
          "kind": "PrometheusDatasource",
          "spec": {
            "proxy": {
              "kind": "HTTPProxy",
              "spec": {
                "url": "{{ perses_prometheus_url }}",
                "allowedEndpoints": [
                  {"endpointPattern": "/api/v1/labels", "method": "POST"},
                  {"endpointPattern": "/api/v1/labels", "method": "GET"},
                  {"endpointPattern": "/api/v1/series", "method": "POST"},
                  {"endpointPattern": "/api/v1/series", "method": "GET"},
                  {"endpointPattern": "/api/v1/metadata", "method": "GET"},
                  {"endpointPattern": "/api/v1/query", "method": "POST"},
                  {"endpointPattern": "/api/v1/query", "method": "GET"},
                  {"endpointPattern": "/api/v1/query_range", "method": "POST"},
                  {"endpointPattern": "/api/v1/query_range", "method": "GET"},
                  {"endpointPattern": "/api/v1/label/([a-zA-Z0-9_-]+)/values", "method": "GET"}
                ]
              }
            }
          }
        }
      }
    }
