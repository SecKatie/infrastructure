---
- name: Create personal-site namespace
  kubernetes.core.k8s:
    name: "{{ personal_site_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
    definition:
      metadata:
        labels:
          app.kubernetes.io/part-of: personal-site
          app.kubernetes.io/managed-by: ansible
        annotations:
          app.kubernetes.io/description: "Personal landing page namespace"

- name: Setup Cloudflare tunnel
  ansible.builtin.include_role:
    name: util_cloudflare_tunnel
  vars:
    cf_tunnel_name: "{{ personal_site_cloudflare_tunnel_name }}"
    cf_tunnel_namespace: "{{ personal_site_namespace }}"
    cf_tunnel_secret_name: "{{ personal_site_cloudflare_tunnel_secret_name }}"
  when: personal_site_cloudflare_tunnel_enabled | default(true)

- name: Deploy Cloudflare tunnel for personal site
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'cloudflared.yaml.j2') | from_yaml_all | list }}"
  when: personal_site_cloudflare_tunnel_enabled | default(true) and (cf_tunnel_configured | default(false))

- name: Deploy personal site application
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  loop: "{{ lookup('template', 'app.yaml.j2') | from_yaml_all | list }}"

- name: Wait for personal site deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: personal-site
    namespace: "{{ personal_site_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Display deployment status
  ansible.builtin.debug:
    msg:
      - "Personal site has been deployed successfully!"
      - ""
      - "External access (Cloudflare tunnel):"
      - "   URL: https://{{ personal_site_external_host }}"
      - "   Tunnel: {{ personal_site_cloudflare_tunnel_name }}"
      - "   Status: {{ 'Configured' if (cf_tunnel_configured | default(false)) else 'Manual setup required' }}"
      - ""
      - "Service: http://personal-site.{{ personal_site_namespace }}.svc.cluster.local:{{ personal_site_port }}"
      - ""
      - "To update the site:"
      - "   1. Push changes to SecKatie/personal-site repo"
      - "   2. GitHub Actions will build and push to quay.io/kmulliken/personal-site"
      - "   3. Restart deployment: kubectl rollout restart deployment/personal-site -n {{ personal_site_namespace }}"
