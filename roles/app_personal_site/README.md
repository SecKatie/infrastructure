# Personal Site Role

Deploys a static personal landing page built with Astro and MDX to Kubernetes with external access via Cloudflare Tunnel.

## Overview

- **Site**: Static HTML generated by Astro from MDX files
- **Hosting**: nginx container serving static files
- **Registry**: quay.io/kmulliken/personal-site (public)
- **Access**: External only via Cloudflare Tunnel at mulliken.net
- **Updates**: Push to GitHub → GitHub Actions builds → restart deployment

## Prerequisites

1. **Container image available at quay.io**
   - GitHub repo: SecKatie/personal-site
   - Quay.io repo: quay.io/kmulliken/personal-site

2. **Cloudflare Tunnel created**
   ```bash
   cloudflared tunnel create personal-site-tunnel
   cloudflared tunnel route dns personal-site-tunnel mulliken.net
   ```

3. **Tunnel credentials available locally**
   - Located at `~/.cloudflared/<tunnel-id>.json`
   - The `util_cloudflare_tunnel` role will create the Kubernetes secret

## Usage

```bash
# Deploy via the dashboards playbook
ansible-playbook -i inventory/hosts.yml playbooks/dashboards.yml --tags personal-site

# Or deploy everything
ansible-playbook -i inventory/hosts.yml playbooks/deploy.yml --tags personal-site
```

## Configuration

All configuration is in `defaults/main.yml`:

| Variable | Default | Description |
|----------|---------|-------------|
| `personal_site_namespace` | `personal-site` | Kubernetes namespace |
| `personal_site_image` | `quay.io/kmulliken/personal-site` | Container image |
| `personal_site_version` | `latest` | Image tag |
| `personal_site_external_host` | `mulliken.net` | External domain |
| `personal_site_cloudflare_tunnel_name` | `personal-site-tunnel` | Tunnel name |

## Updating the Site

1. Edit MDX files in the `SecKatie/personal-site` repository
2. Push to the `main` branch
3. GitHub Actions automatically builds and pushes to quay.io
4. Restart the deployment to pull the new image:
   ```bash
   kubectl rollout restart deployment/personal-site -n personal-site
   ```

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    GitHub (SecKatie/personal-site)          │
│                              │                              │
│                              ▼                              │
│                    GitHub Actions (build)                   │
│                              │                              │
│                              ▼                              │
│              quay.io/kmulliken/personal-site                │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                    Kubernetes Cluster                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Namespace: personal-site                │   │
│  │                                                      │   │
│  │  ┌──────────────┐         ┌──────────────────────┐  │   │
│  │  │  Deployment  │         │     Deployment       │  │   │
│  │  │  (nginx)     │◄────────│   (cloudflared)      │  │   │
│  │  └──────────────┘         └──────────────────────┘  │   │
│  │         │                           │               │   │
│  │         ▼                           │               │   │
│  │  ┌──────────────┐                   │               │   │
│  │  │   Service    │                   │               │   │
│  │  │   (ClusterIP)│                   │               │   │
│  │  └──────────────┘                   │               │   │
│  └─────────────────────────────────────│───────────────┘   │
└────────────────────────────────────────│───────────────────┘
                                         │
                                         ▼
                              ┌──────────────────┐
                              │  Cloudflare Edge │
                              │   mulliken.net   │
                              └──────────────────┘
```

## Troubleshooting

### Image not found
Ensure the GitHub Actions workflow has run successfully and pushed to quay.io:
```bash
# Check if image exists
podman pull quay.io/kmulliken/personal-site:latest
```

### Tunnel not working
Check cloudflared logs:
```bash
kubectl logs -n personal-site deployment/cloudflared
```

Verify tunnel is configured:
```bash
cloudflared tunnel list
cloudflared tunnel route dns personal-site-tunnel mulliken.net
```

### Site not updating
Force a new deployment:
```bash
kubectl rollout restart deployment/personal-site -n personal-site
kubectl rollout status deployment/personal-site -n personal-site
```
